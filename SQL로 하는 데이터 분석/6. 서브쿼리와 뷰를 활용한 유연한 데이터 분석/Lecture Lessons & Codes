서브 쿼리
* SQL 문에 부품처럼 들어가는 SELECT 문
* Sub (하위의) Query (데이터베이스에 보내는 요청)
* 서브쿼리를 쓸 때는 괄호로 서브쿼리를 꼭 감싸줘야한다


ex)
SELECT i.id, i.name, AVG(star) AS avg_star
FROM item AS i LEFT OUTER JOIN review AS r
ON r.item_id = i.id
GROUP BY i.id, i.name
HAVING avg_star < (SELECT AVG(star) FROM review)       -> 괄호 안의 부분이 서브쿼리
ORDER BY avg_star DESC;

서브쿼리는 SQL 문 안에 부품처럼 들어있는 “SELECT 문”이라고 했습니다.

(참고로 우리는 이번 챕터에서 여러 종류의 SQL 문 중 SELECT 문을 배웠습니다, SELECT 문은 우리가 배운 것처럼 데이터 조회 및 분석을 위한 SQL 문인데요.

이밖에도 데이터 삽입, 갱신, 삭제를 위한 SQL 문들도 있습니다. 이런 SQL 문들은 곧이은 다른 토픽에서 배우게 될 겁니다. 우리가 아직 배우지 않은 종류의 SQL 문 안에도 서브쿼리가 그 일부로 들어갈 수 있습니다, 참고하세요)

이전 영상에서 쓴 SQL 문을 다시 볼까요? 

지금 전체 SQL 문을 파란 박스, 서브쿼리를 빨간색 박스로 표시했는데요. 이 때 서브쿼리를 포함하는 전체 SQL 문을 outer query(외부 쿼리), 서브쿼리를 inner query(내부 쿼리)라고 하기도 합니다. 

이전 영상에서 서브쿼리를 사용했을 때 어땠나요? 쿼리 창을 새로 켤 필요없이, 하나의 쿼리 창에서 하나의 SQL 문만으로도 원하는 결과를 얻을 수 있었죠? 이렇게 적재적소에 서브쿼리를 사용하면 여러분이 원하는 결과를 좀더 편하게 얻을 수 있습니다. 위 그림을 보면 지금 서브쿼리가 HAVING 절에서 사용됐는데요. 서브쿼리는 HAVING 절 뿐만 아니라 SELECT 절, WHERE 절, FROM 절 등에서도 사용할 수 있습니다. 

서브쿼리의 다양한 사용법을 이번 챕터에서 하나씩 배워봅시다
--------------------------------------------------------------------------------------------------------------------------------

SELECT 절에 있는 서브쿼리

ex)
SELECT 
id, name, price, (SELECT MAX(price) FROM item) AS max_price   -> 나중에 copang_main.item 으로 한번 해보자
FROM copang_main.item;


WHERE 절에 있는 서브쿼리

ex)
SELECT 
id, name, price, (SELECT AVG(price) FROM item) AS avg_price
FROM copang_main.item
WHERE price >= (SELECT AVG(price) FROM item);

ex)
SELECT 
id, name, price, (SELECT AVG(price) FROM item) AS avg_price
FROM copang_main.item
WHERE price = (SELECT MAX(price) FROM item);


* 위의 서브쿼리들은 모두 값 하나만을 리턴하는 서브쿼리들이다
* 서브쿼리가 모두 값 하나만을 리턴하지는 않는다

코팡의 상품들 중에서 리뷰가 최소 3개 이상 달린 상품의 정보만 보려면 어떻게 해야할까?
1. 조인을 이용해서
2. 서브쿼리를 이용해서

ex1)

SELECT *
FROM item AS i LEFT OUTER JOIN review AS r
ON i.id = review.item_id
GROUP BY i.id, i.name
HAVING COUNT(*) > 2;

ex2)

SELECT * FROM item
WHERE id IN
( 
SELECT item_id
FROM review
GROUP BY item_id HAVING COUNT(*) >= 3
);
-> 이 경우 서브 쿼리가 하나의 값만을 리턴하지 않는다
